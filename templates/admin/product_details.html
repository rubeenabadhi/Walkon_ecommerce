{% extends 'admin/base.html' %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-md-12">
      <h1 class="mb-4">Product Details</h1>
    </div>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
<!-- Header -->
    <div class="content-67 mb-4">
      <h1 class="title-68 text-rgb-9-9-9 fw-bold fs-2">{{ product.name }}</h1>
    </div>

    
        

<div class="row">
  <!-- Product Information (Left Side) -->
  <div class="col-md-6">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title text-rgb-9-9-9 fw-bold">{{ product.name }}</h5>

        <div class="mb-3">
          <strong class="text-rgb-159-155-155">Product ID:</strong>
          <span class="text-rgb-59-51-137">{{ product.product_id }}</span>
        </div>

        <div class="mb-3">
          <strong class="text-rgb-159-155-155">Price:</strong>
          <span>${{ product.price }}</span>
        </div>

        <div class="mb-3">
          <strong class="text-rgb-159-155-155">Added On:</strong>
          <span>{{ product.added_on|date:"d-m-Y" }}</span>
        </div>

        <div class="mb-3">
          <strong class="text-rgb-159-155-155">Category:</strong>
          <span>{{ product.category }}</span>
        </div>

        <div class="mb-3">
          <strong class="text-rgb-159-155-155">Stock:</strong>
          <span>{{ product.stock }}</span>
        </div>

        <div class="mb-3">
          <strong class="text-rgb-159-155-155">Status:</strong>
          <span class="frame-293-102 d-inline-flex justify-content-center align-items-center gap-2 px-3 py-1 bg-success-subtle border border-success rounded text-rgb-0-135-103">
            {{ product.status }}
          </span>
        </div>

        <div class="mb-3">
          <strong class="text-rgb-159-155-155">Description:</strong>
          <p class="text-rgb-17-24-39">{{ product.description|default:"No description available." }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Product Images (Right Side) -->
  <div class="col-md-6">
    <div class="card">
      <div class="card-body text-center">
        <h5 class="fw-bold mb-3">Product Images</h5>

        <!-- Primary Image -->
        {% if product.primary_image %}
          <img src="{{ product.primary_image.url }}" alt="Primary Image" class="img-fluid rounded mb-3" style="max-height: 300px;">
        {% else %}
          <p>No primary image available.</p>
        {% endif %}

        <!-- Additional Images -->
        <div class="d-flex flex-wrap justify-content-center gap-2">
          {% for image in product.images.all %}
            <img src="{{ image.url }}" alt="Product Image" class="img-thumbnail" style="width: 100px; height: 100px; object-fit: cover;">
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Product Images -->
<div class="col-md-6">
  <div class="card mb-3">
    {% if variants %}
      <div id="productImagesCarousel" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-inner">
          {% for variant in variants %}
            {% for img in variant.images.all %}
              <div class="carousel-item {% if forloop.first and forloop.parentloop.first %}active{% endif %}">
                <img src="{{ img.url }}" 
                     alt="{{ img.alt_text|default:product.name }}" 
                     class="d-block w-100" 
                     style="max-height:400px; object-fit:contain;">
              </div>
            {% endfor %}
          {% endfor %}
        </div>
        <!-- Carousel controls -->
        <button class="carousel-control-prev" type="button" data-bs-target="#productImagesCarousel" data-bs-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#productImagesCarousel" data-bs-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Next</span>
        </button>
      </div>
    {% else %}
      <div class="card-img-top placeholder-image d-flex align-items-center justify-content-center bg-light">
        <span class="text-muted">No Images Available</span>
      </div>
    {% endif %}
  </div>
</div>

          <!-- Action Buttons -->
            <div class="d-flex gap-2">
              <a href="#" class="btn btn-light cell-action-button p-2" title="Edit">
                <i class="bi bi-pencil"></i>
              </a>
<a href="javascript:void(0);" 
   class="btn btn-light cell-action-button p-2 delete-product" 
   title="Delete" 
   data-slug="{{ product.slug }}">
    <i class="bi bi-trash"></i>
</a>
              <a href="{% url 'products' %}" class="btn btn-light cell-action-button p-2" title="Back to List">
                <i class="bi bi-arrow-left"></i>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg rounded-4">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill me-2"></i> Confirm Delete</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <p class="fs-5">Are you sure you want to delete this product?</p>
        <p class="text-muted">This will also remove all its variants.</p>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger px-4" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>
</div>
  </div>
</div>  
<!-- JavaScript for Delete Confirmation -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>

   document.addEventListener("DOMContentLoaded", () => {
    let deleteSlug = null;

    // Open modal
    document.querySelectorAll(".delete-product").forEach(btn => {
        btn.addEventListener("click", function(e) {
            e.preventDefault();
            deleteSlug = this.dataset.slug;
            const modal = new bootstrap.Modal(document.getElementById("deleteConfirmModal"));
            modal.show();
        });
    });

    // Confirm delete
    document.getElementById("confirmDeleteBtn").addEventListener("click", function() {
        if (!deleteSlug) return;

        fetch(`/product/${deleteSlug}/delete/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": getCookie("csrftoken"),
                "X-Requested-With": "XMLHttpRequest"
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById("deleteConfirmModal")).hide();
                
                // Show success toast
                alert(data.message);
                window.location.href = "products/"; // ðŸ‘ˆ go to product list
            } else {
                alert("Error: " + data.message);
            }
        })
        .catch(err => console.error(err));
    });
});

// Helper for CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
    {% endblock %}